<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <title>DPP-Battery Passport</title>

  <style>
    :root{
      --bg:#0a0f1b;
      --line: rgba(255,255,255,.10);
      --line2: rgba(120,160,255,.16);
      --text:#e9f0ff;
      --muted: rgba(233,240,255,.72);
      --muted2: rgba(233,240,255,.55);
      --blue:#67c7ff;
      --teal:#3fe0c1;
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --shadow2: 0 14px 44px rgba(0,0,0,.35);
      --r: 22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f3f6ff;
        --line: rgba(17,24,39,.10);
        --line2: rgba(30,64,175,.14);
        --text:#0c1428;
        --muted: rgba(12,20,40,.70);
        --muted2: rgba(12,20,40,.55);
        --shadow: 0 26px 70px rgba(15, 23, 42, .16);
        --shadow2: 0 16px 44px rgba(15, 23, 42, .10);
      }
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1000px 600px at 15% -10%, rgba(103,199,255,.18), transparent 60%),
        radial-gradient(900px 560px at 100% 0%, rgba(63,224,193,.10), transparent 58%),
        var(--bg);
      overflow-x:hidden;
    }
    a{ color: var(--blue); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 12px 52px;
      padding-bottom: calc(52px + env(safe-area-inset-bottom, 0px));
    }
    .shell{
      border: 1px solid var(--line);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 14px 14px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.16), transparent);
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap: 10px; min-width: 220px; }
    .avatar{
      width: 30px; height: 30px; border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      flex: 0 0 auto;
    }
    .title{
      font-weight: 950;
      letter-spacing:.2px;
      margin:0;
      font-size: 16px;
      line-height: 1.2;
      white-space: nowrap;
    }
    .topright{ display:flex; align-items:center; gap: 10px; flex-wrap:wrap; justify-content:flex-end; }

    .btn{
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      box-shadow: var(--shadow2);
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      font-size: 14px;
      display:inline-flex; align-items:center; gap: 8px;
      backdrop-filter: blur(10px);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ border-color: rgba(103,199,255,.38); background: rgba(255,255,255,.07); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(103,199,255,.55);
      background: rgba(103,199,255,.10);
    }

    .subline{
      padding: 10px 14px 0;
      color: var(--muted);
      font-size: 14px;
    }
    .content{ padding: 14px; }

    .grid2{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
      margin-top: 10px;
    }

    .card{
      border: 1px solid var(--line2);
      border-radius: var(--r);
      background: rgba(0,0,0,.10);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }
    .card .head{
      display:flex; align-items:center; gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      font-weight: 950;
      letter-spacing:.2px;
      font-size: 18px;
    }
    .card .body{
      padding: 12px 14px 14px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
    }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .inlineLink{ display:flex; align-items:center; gap: 8px; flex-wrap:wrap; word-break: break-word; }
    .iconBtn{
      width: 28px; height: 28px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer;
      flex: 0 0 auto;
      -webkit-tap-highlight-color: transparent;
    }

    .kv{
      display:grid;
      grid-template-columns: 165px 1fr;
      gap: 8px 12px;
      align-items:start;
    }
    .k{ color: var(--muted2); }
    .v{ color: var(--text); word-break: break-word; }

    .tabsShell{
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: rgba(0,0,0,.10);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .tabs{
      display:flex;
      gap: 8px;
      align-items:center;
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      background: rgba(0,0,0,.06);
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .tabs::-webkit-scrollbar{ display:none; }

    .tab{
      padding: 10px 12px;
      color: var(--muted2);
      font-size: 14px;
      cursor:pointer;
      border-radius: 12px;
      user-select:none;
      white-space: nowrap;
      flex: 0 0 auto;
      border: 1px solid transparent;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tab.active{
      color: var(--blue);
      font-weight: 900;
      background: rgba(103,199,255,.10);
      border-color: rgba(103,199,255,.22);
    }
    .tabsBody{ padding: 14px; }

    .cols2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .miniCard{
      border: 1px solid var(--line2);
      border-radius: var(--r);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .miniHead{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; gap: 10px;
      font-weight: 950;
      font-size: 16px;
    }
    .miniBody{
      padding: 12px 14px 14px;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
    }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    .kpi{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
    }
    .kpi .t{ color: var(--muted2); font-size: 12px; font-weight: 800; }
    .kpi .n{ color: var(--text); font-size: 16px; font-weight: 950; margin-top: 4px; line-height: 1.2; }
    .kpi .s{ color: var(--muted); font-size: 12px; margin-top: 4px; }

    details{
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      margin-top: 10px;
    }
    summary{
      cursor:pointer;
      color: var(--text);
      font-weight: 900;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .detailList{
      margin: 10px 0 0;
      padding-left: 18px;
      color: var(--muted);
      line-height: 1.55;
    }

    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size: 13px;
      font-weight: 800;
      width: fit-content;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--blue); }

    .i18 svg{ width:18px; height:18px; }
    .i16 svg{ width:16px; height:16px; }
    .i14 svg{ width:14px; height:14px; }
    svg{ opacity:.92; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.75);
      color: #fff;
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-6px); }

    @media (max-width: 920px){
      .grid2{ grid-template-columns: 1fr; }
      .cols2{ grid-template-columns: 1fr; }
    }
    @media (max-width: 600px){
      .header{ flex-direction: column; align-items: stretch; gap: 10px; }
      .title{ white-space: normal; }
      .topright{ width:100%; justify-content: stretch; }
      .btn{ width:100%; justify-content:center; }
      .kv{ grid-template-columns: 1fr; }
      .kpis{ grid-template-columns: 1fr; }
    }

    .clean .header,
    .clean .subline { display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="shell">
      <div class="header">
        <div class="brand">
          <div class="avatar" aria-hidden="true"></div>
          <div class="title">DPP-Battery Passport</div>
        </div>

        <div class="topright">
          <button class="btn" id="copyLink">Link kopyala</button>
          <button class="btn primary" id="goAccess">Access</button>
        </div>
      </div>

      <div class="subline">QR kod ile batarya pasaportuna erişim.</div>

      <div class="content" id="app"></div>
    </div>
  </div>

  <div class="toast" id="toast">Kopyalandı</div>

<script>
  // ------------------------------------------------------------
  // Demo DB (CN vs EU) — “gereklilik” alanları eklenmiştir.
  // ------------------------------------------------------------
  const DB = {
    "urn:iso:15459:DPPBAT.CN.EV.2026.000001": {
      identification: {
        upi: { gtin: "06912345678901", serial: "CN2026-000001" }, // UPI örnek
        uid: "urn:iso:15459:DPPBAT.CN.EV.2026.000001"
      },
      overview: {
        category: "EV traction battery",
        model: "PC-EV-NMC811-75kWh"
      },
      manufacturer: {
        name: "Shenzhen PowerCell Ltd.",
        brand: "PowerCell",
        operator_id: "UOI-CN-POWER-0001", // Unique Operator Identifier (örnek)
        address: "Nanshan District, Shenzhen, Guangdong, China",
        email: "compliance@powercell.example",
        website: "https://powercell.example"
      },
      facility: {
        ufi: "UFI-CN-SZ-PLANT-01", // Unique Facility Identifier (örnek)
        location: "Shenzhen, Guangdong (CN)",
        production: "December 2026"
      },
      safety: {
        hazardous: "Declared\nCobalt, Nickel as REACH ≥ 0.1%",
        extinguishing: "Water mist, Class D media, BC powder"
      },
      sustainability: {
        carbon: "58.0 kgCO₂e / kWh",
        class: "C",
        recycled: { co: "6%", ni: "5%", li: "2%", pb: "0%" },
        renewable_share: "0% (N/A)", // varsa
        lifecycle: [
          { stage: "Raw materials", value: "32.0 kgCO₂e/kWh" },
          { stage: "Cell manufacturing", value: "18.5 kgCO₂e/kWh" },
          { stage: "Pack assembly", value: "4.0 kgCO₂e/kWh" },
          { stage: "Transport", value: "3.5 kgCO₂e/kWh" }
        ],
        method: "Methodology reference"
      },
      performance: {
        nominal_capacity_ah: "210 Ah",
        voltage_range: "min 2.8 V · nom 3.7 V · max 4.2 V (cell)",
        original_power_w: "150,000 W (peak, example)",
        temperature_range: "-20°C to +55°C (operation)",
        expected_life: { cycle_life: "1,200 cycles (ref conditions)", calendar_life: "10 years (ref conditions)" },
        energy_efficiency: { initial: "93%", at_50pct_cycle_life: "89%" },
        internal_resistance: { cell: "1.8 mΩ", pack: "22 mΩ" }
      },
      circularity: {
        takeback: "National collection / take-back guidance (placeholder)."
      },
      materials: {
        chemistry: "NMC 811",
        critical_materials: ["Cobalt", "Lithium", "Nickel", "Graphite"],
        hazardous_substances: ["Nickel compounds", "Cobalt compounds (declared)"]
      },
      repair_disassembly: {
        exploded_diagram_url: "https://example.com/exploded-diagram",
        disassembly_steps: [
          "Isolate HV and verify zero potential.",
          "Remove enclosure fasteners (Torx T30, x24).",
          "Disconnect BMS harness and thermal interface."
        ],
        fasteners: "Torx T30 · x24 (example)",
        tools: ["Insulated torque wrench", "Torx T30 bit", "PPE (Class 0 gloves)"],
        precautions: ["Thermal runaway risk", "Electrolyte exposure risk"]
      },
      spare_parts: [
        { part_no: "SP-CN-001", name: "BMS Harness", supplier: "PowerCell Service", contact: "service@powercell.example" },
        { part_no: "SP-CN-002", name: "Seal Kit", supplier: "PowerCell Service", contact: "service@powercell.example" }
      ],
      documents: [
        { title: "EU Declaration of Conformity (placeholder)", url: "https://example.com/eu-doc" },
        { title: "Carbon footprint study (placeholder)", url: "https://example.com/pcf" }
      ],
      authority_dynamic: {
        soh: "98.4%",
        remaining_capability: "Capacity 98% · Power 97% (example)",
        usage_history: {
          cycles: 62,
          high_temp_exposure: "12 h > 45°C (example)",
          deep_discharge_events: 1,
          incidents: "None reported"
        },
        status: "Original"
      },
      due_diligence: [
        { material: "Cobalt", evidence: "Responsible sourcing report (placeholder)", url: "https://example.com/dd-cobalt" },
        { material: "Lithium", evidence: "Supplier audit statement (placeholder)", url: "https://example.com/dd-lithium" },
        { material: "Nickel", evidence: "Certification (placeholder)", url: "https://example.com/dd-nickel" },
        { material: "Graphite", evidence: "Traceability note (placeholder)", url: "https://example.com/dd-graphite" }
      ]
    },

    "urn:iso:15459:DPPBAT.EU.EV.2026.000001": {
      identification: {
        upi: { gtin: "08712345678901", serial: "EU2026-000001" },
        uid: "urn:iso:15459:DPPBAT.EU.EV.2026.000001"
      },
      overview: {
        category: "EV traction battery",
        model: "EC-EV-NMC811-75kWh"
      },
      manufacturer: {
        name: "EuroCell Energy S.A.",
        brand: "EuroCell",
        operator_id: "UOI-EU-EUROCELL-0001",
        address: "Wroclaw, Poland",
        email: "compliance@eurocell.example",
        website: "https://eurocell.example"
      },
      facility: {
        ufi: "UFI-EU-PL-PLANT-01",
        location: "Wroclaw (PL)",
        production: "December 2026"
      },
      safety: {
        hazardous: "Declared\nNickel as REACH ≥ 0.1%",
        extinguishing: "Water mist, Class D media, BC powder"
      },
      sustainability: {
        carbon: "41.5 kgCO₂e / kWh",
        class: "B",
        recycled: { co: "10%", ni: "8%", li: "4%", pb: "0%" },
        renewable_share: "15% (example)",
        lifecycle: [
          { stage: "Raw materials", value: "22.0 kgCO₂e/kWh" },
          { stage: "Cell manufacturing", value: "14.0 kgCO₂e/kWh" },
          { stage: "Pack assembly", value: "3.0 kgCO₂e/kWh" },
          { stage: "Transport", value: "2.5 kgCO₂e/kWh" }
        ],
        method: "Methodology reference"
      },
      performance: {
        nominal_capacity_ah: "210 Ah",
        voltage_range: "min 2.8 V · nom 3.7 V · max 4.2 V (cell)",
        original_power_w: "150,000 W (peak, example)",
        temperature_range: "-20°C to +55°C (operation)",
        expected_life: { cycle_life: "1,300 cycles (ref conditions)", calendar_life: "12 years (ref conditions)" },
        energy_efficiency: { initial: "94%", at_50pct_cycle_life: "90%" },
        internal_resistance: { cell: "1.7 mΩ", pack: "20 mΩ" }
      },
      circularity: {
        takeback: "National collection / take-back guidance (placeholder)."
      },
      materials: {
        chemistry: "NMC 811",
        critical_materials: ["Cobalt", "Lithium", "Nickel", "Graphite"],
        hazardous_substances: ["Nickel compounds (declared)"]
      },
      repair_disassembly: {
        exploded_diagram_url: "https://example.com/exploded-diagram",
        disassembly_steps: [
          "Isolate HV and verify zero potential.",
          "Remove enclosure fasteners (Torx T30, x22).",
          "Disconnect BMS harness and thermal interface."
        ],
        fasteners: "Torx T30 · x22 (example)",
        tools: ["Insulated torque wrench", "Torx T30 bit", "PPE (Class 0 gloves)"],
        precautions: ["Thermal runaway precautions", "Electrolyte exposure risk"]
      },
      spare_parts: [
        { part_no: "SP-EU-001", name: "BMS Harness", supplier: "EuroCell Service", contact: "service@eurocell.example" },
        { part_no: "SP-EU-002", name: "Seal Kit", supplier: "EuroCell Service", contact: "service@eurocell.example" }
      ],
      documents: [
        { title: "EU Declaration of Conformity (placeholder)", url: "https://example.com/eu-doc" },
        { title: "Carbon footprint study (placeholder)", url: "https://example.com/pcf" }
      ],
      authority_dynamic: {
        soh: "99.1%",
        remaining_capability: "Capacity 99% · Power 98% (example)",
        usage_history: {
          cycles: 58,
          high_temp_exposure: "6 h > 45°C (example)",
          deep_discharge_events: 0,
          incidents: "None reported"
        },
        status: "Original"
      },
      due_diligence: [
        { material: "Cobalt", evidence: "Responsible sourcing report (placeholder)", url: "https://example.com/dd-cobalt" },
        { material: "Lithium", evidence: "Supplier audit statement (placeholder)", url: "https://example.com/dd-lithium" },
        { material: "Nickel", evidence: "Certification (placeholder)", url: "https://example.com/dd-nickel" },
        { material: "Graphite", evidence: "Traceability note (placeholder)", url: "https://example.com/dd-graphite" }
      ]
    }
  };

  // ------------------------------------------------------------
  // URL Params: uid OR short id=CN/EU
  // ------------------------------------------------------------
  const qs = new URLSearchParams(location.search);

  const UID_MAP = {
    "CN": "urn:iso:15459:DPPBAT.CN.EV.2026.000001",
    "EU": "urn:iso:15459:DPPBAT.EU.EV.2026.000001"
  };

  const id = (qs.get("id") || "").toUpperCase();
  const uid = qs.get("uid") || UID_MAP[id] || Object.keys(DB)[0];

  const role = (qs.get("role") || "public").toLowerCase(); // public|professional|authority
  const tab  = (qs.get("tab")  || "details").toLowerCase(); // details|sustainability|circularity|documents|access

  if(qs.get("mode")==="clean") document.body.classList.add("clean");

  function baseUrl(){ return location.origin + location.pathname; }
  function linkFor(next = {}){
    const p = new URLSearchParams(location.search);
    for(const [k,v] of Object.entries(next)){
      if(v === null) p.delete(k);
      else p.set(k, v);
    }
    return `${baseUrl()}?${p.toString()}`;
  }
  function esc(s){
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  const ROLE_LEVEL = { public: 0, professional: 1, authority: 2 };
  function canSee(minRole){
    return (ROLE_LEVEL[role] ?? 0) >= (ROLE_LEVEL[minRole] ?? 0);
  }

  const toast = document.getElementById("toast");
  let toastTimer = null;
  function showToast(msg="Kopyalandı"){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove("show"), 1400);
  }
  async function copy(text){
    try{ await navigator.clipboard.writeText(text); showToast("Kopyalandı"); }
    catch{ prompt("Kopyalamak için:", text); }
  }

  // Icons
  const S = `fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"`;
  const ICONS = {
    doc: `<span class="i18"><svg viewBox="0 0 24 24" ${S}>
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/>
    </svg></span>`,
    shield:`<span class="i18"><svg viewBox="0 0 24 24" ${S}>
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      <path d="M9 12l2 2 4-4"/>
    </svg></span>`,
    info:`<span class="i14"><svg viewBox="0 0 24 24" ${S}>
      <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
    </svg></span>`,
    leaf:`<span class="i14"><svg viewBox="0 0 24 24" ${S}>
      <path d="M11 20c6 0 10-4 10-10V4s-6 0-10 4-4 10-4 10 1 2 4 2z"/>
      <path d="M21 4L11 14"/>
    </svg></span>`,
    recycle:`<span class="i14"><svg viewBox="0 0 24 24" ${S}>
      <path d="M7 19l-2-3 3-2"/><path d="M3 16h6"/>
      <path d="M7 5l2 3-3 2"/><path d="M9 8H3"/>
      <path d="M17 19l-2 3-3-2"/><path d="M21 16h-6"/>
      <path d="M17 5l2-3 3 2"/><path d="M15 8h6"/>
    </svg></span>`,
    file:`<span class="i14"><svg viewBox="0 0 24 24" ${S}>
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <path d="M14 2v6h6"/>
    </svg></span>`,
    key:`<span class="i14"><svg viewBox="0 0 24 24" ${S}>
      <path d="M21 2l-2 2"/><path d="M11.5 11.5a4.5 4.5 0 1 1 6.36 6.36L14 22l-4-4 1.5-1.5 2 2L16 16l-2-2 1.5-1.5 2 2 1.36-1.36"/>
    </svg></span>`,
    clip:`<span class="i16"><svg viewBox="0 0 24 24" ${S}>
      <path d="M21.44 11.05l-9.19 9.19a5 5 0 0 1-7.07-7.07l9.9-9.9a3.5 3.5 0 0 1 4.95 4.95l-10.6 10.6a2 2 0 1 1-2.83-2.83l9.9-9.9"/>
    </svg></span>`
  };

  const app = document.getElementById("app");
  const data = DB[uid];

  function tabBtn(name, key, icon){
    return `<div class="tab ${tab===key?'active':''}" data-tab="${key}">${icon}<span>${name}</span></div>`;
  }

  function viewChip(){
    const label = role === "authority" ? "Authority" : (role === "professional" ? "Professional" : "Public");
    return `<span class="chip"><span class="dot"></span>${label}</span>`;
  }

  function renderNotFound(){
    app.innerHTML = `
      <div class="card">
        <div class="head">${ICONS.doc} DPP-Battery Passport</div>
        <div class="body">UID için kayıt bulunamadı: <span class="mono">${esc(uid)}</span></div>
      </div>
    `;
  }

  function showTabBody(tabBody){
    const d = data;

    if(tab === "details"){
      const upi = d.identification?.upi || {};
      tabBody.innerHTML = `
        <div class="miniCard">
          <div class="miniHead">${ICONS.info} Details</div>
          <div class="miniBody">
            ${viewChip()}
            <div style="height:10px"></div>

            <div class="kv">
              <div class="k">Shareable link</div>
              <div class="v"><a href="${esc(linkFor({uid, role, tab:"details"}))}">${esc(linkFor({uid, role, tab:"details"}))}</a></div>

              <div class="k">UID</div>
              <div class="v inlineLink"><span class="mono">${esc(d.identification?.uid)}</span>
                <span class="iconBtn" id="copyUid" title="Copy UID">${ICONS.clip}</span>
              </div>

              <div class="k">Select</div>
              <div class="v">
                <select id="pick" style="width:100%; padding:12px 12px; border-radius:14px; border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text); font-size:14px;">
                  ${Object.keys(DB).map(k=>`<option value="${k}" ${k===uid?'selected':''}>${k.includes(".CN.")?"China (CN)":"EU (EU)"} — ${k}</option>`).join("")}
                </select>
              </div>
            </div>

            <details>
              <summary>Identifiers</summary>
              <div class="kv" style="margin-top:10px;">
                <div class="k">UPI (GTIN)</div><div class="v"><span class="mono">${esc(upi.gtin)}</span></div>
                <div class="k">UPI (Serial)</div><div class="v"><span class="mono">${esc(upi.serial)}</span></div>
                <div class="k">Category</div><div class="v">${esc(d.overview?.category)}</div>
                <div class="k">Model</div><div class="v">${esc(d.overview?.model)}</div>
              </div>
            </details>

            <details>
              <summary>Manufacturer</summary>
              <div class="kv" style="margin-top:10px;">
                <div class="k">Name</div><div class="v">${esc(d.manufacturer?.name)}</div>
                <div class="k">Brand</div><div class="v">${esc(d.manufacturer?.brand)}</div>
                <div class="k">Operator ID</div><div class="v"><span class="mono">${esc(d.manufacturer?.operator_id)}</span></div>
                <div class="k">Address</div><div class="v">${esc(d.manufacturer?.address)}</div>
                <div class="k">Email</div><div class="v">${esc(d.manufacturer?.email)}</div>
                <div class="k">Website</div><div class="v"><a href="${esc(d.manufacturer?.website)}" target="_blank" rel="noopener">${esc(d.manufacturer?.website)}</a></div>
              </div>
            </details>

            <details>
              <summary>Facility & production</summary>
              <div class="kv" style="margin-top:10px;">
                <div class="k">Facility ID (UFI)</div><div class="v"><span class="mono">${esc(d.facility?.ufi)}</span></div>
                <div class="k">Location</div><div class="v">${esc(d.facility?.location)}</div>
                <div class="k">Production date</div><div class="v">${esc(d.facility?.production)}</div>
              </div>
            </details>

            <details>
              <summary>Performance & durability</summary>
              <div class="kv" style="margin-top:10px;">
                <div class="k">Nominal capacity</div><div class="v">${esc(d.performance?.nominal_capacity_ah)}</div>
                <div class="k">Voltage range</div><div class="v">${esc(d.performance?.voltage_range)}</div>
                <div class="k">Original power</div><div class="v">${esc(d.performance?.original_power_w)}</div>
                <div class="k">Temperature</div><div class="v">${esc(d.performance?.temperature_range)}</div>

                <div class="k">Cycle life</div><div class="v">${esc(d.performance?.expected_life?.cycle_life)}</div>
                <div class="k">Calendar life</div><div class="v">${esc(d.performance?.expected_life?.calendar_life)}</div>

                <div class="k">Energy efficiency</div><div class="v">${esc(d.performance?.energy_efficiency?.initial)} (initial) · ${esc(d.performance?.energy_efficiency?.at_50pct_cycle_life)} (@50%)</div>
                <div class="k">Internal resistance</div><div class="v">${esc(d.performance?.internal_resistance?.cell)} (cell) · ${esc(d.performance?.internal_resistance?.pack)} (pack)</div>
              </div>
            </details>

          </div>
        </div>
      `;

      document.getElementById("copyUid").onclick = ()=> copy(d.identification?.uid || "");
      document.getElementById("pick").addEventListener("change",(e)=>{
        location.href = linkFor({ uid: e.target.value, tab:"details" });
      });
      return;
    }

    if(tab === "sustainability"){
      const s = d.sustainability || {};
      const rec = s.recycled || {};
      tabBody.innerHTML = `
        <div class="miniCard">
          <div class="miniHead">${ICONS.leaf} Sustainability</div>
          <div class="miniBody">
            ${viewChip()}
            <div style="height:10px"></div>

            <div class="kpis">
              <div class="kpi">
                <div class="t">Carbon footprint</div>
                <div class="n" style="color:var(--blue)">${esc(s.carbon)}</div>
                <div class="s">kgCO₂e / kWh</div>
              </div>
              <div class="kpi">
                <div class="t">Performance class</div>
                <div class="n">${esc(s.class)}</div>
                <div class="s">Declared</div>
              </div>
              <div class="kpi">
                <div class="t">Recycled content</div>
                <div class="n">Co ${esc(rec.co)} · Ni ${esc(rec.ni)} · Li ${esc(rec.li)}</div>
                <div class="s">Pb ${esc(rec.pb)}</div>
              </div>
            </div>

            <div class="kv">
              <div class="k">Renewable share</div>
              <div class="v">${esc(s.renewable_share)}</div>
              <div class="k">Method</div>
              <div class="v">${esc(s.method)}</div>
            </div>

            <details>
              <summary>Lifecycle breakdown</summary>
              <ul class="detailList">
                ${(s.lifecycle||[]).map(x=>`<li><b>${esc(x.stage)}:</b> ${esc(x.value)}</li>`).join("")}
              </ul>
            </details>
          </div>
        </div>
      `;
      return;
    }

    if(tab === "circularity"){
      const showPro = canSee("professional") || canSee("authority");
      tabBody.innerHTML = `
        <div class="cols2">
          <div class="miniCard">
            <div class="miniHead">${ICONS.recycle} Circularity</div>
            <div class="miniBody">
              ${viewChip()}
              <div style="height:10px"></div>
              <div class="kv">
                <div class="k">Collection / take-back</div>
                <div class="v">${esc(d.circularity?.takeback)}</div>
              </div>
            </div>
          </div>

          <div class="miniCard">
            <div class="miniHead">${ICONS.recycle} Repair & materials</div>
            <div class="miniBody">
              ${
                showPro
                ? `
                  <details open>
                    <summary>Chemistry & materials</summary>
                    <ul class="detailList">
                      <li><b>Chemistry:</b> ${esc(d.materials?.chemistry)}</li>
                      <li><b>Critical materials:</b> ${esc((d.materials?.critical_materials||[]).join(", "))}</li>
                      <li><b>Declared hazardous:</b> ${esc((d.materials?.hazardous_substances||[]).join(", "))}</li>
                    </ul>
                  </details>

                  <details>
                    <summary>Disassembly & repair</summary>
                    <div style="margin-top:10px; color:var(--muted);">
                      <div><b>Fasteners:</b> ${esc(d.repair_disassembly?.fasteners)}</div>
                      <div><b>Exploded diagram:</b> <a href="${esc(d.repair_disassembly?.exploded_diagram_url)}" target="_blank" rel="noopener">link</a></div>
                      <div style="margin-top:10px;"><b>Steps</b></div>
                      <ul class="detailList">${(d.repair_disassembly?.disassembly_steps||[]).map(x=>`<li>${esc(x)}</li>`).join("")}</ul>

                      <div style="margin-top:10px;"><b>Tools</b></div>
                      <ul class="detailList">${(d.repair_disassembly?.tools||[]).map(x=>`<li>${esc(x)}</li>`).join("")}</ul>

                      <div style="margin-top:10px;"><b>Precautions</b></div>
                      <ul class="detailList">${(d.repair_disassembly?.precautions||[]).map(x=>`<li>${esc(x)}</li>`).join("")}</ul>
                    </div>
                  </details>

                  <details>
                    <summary>Spare parts</summary>
                    <ul class="detailList">
                      ${(d.spare_parts||[]).map(p=>`<li><b>${esc(p.part_no)}</b> — ${esc(p.name)} · ${esc(p.supplier)} · ${esc(p.contact)}</li>`).join("")}
                    </ul>
                  </details>
                `
                : `<div style="color:var(--muted);">Restricted (Professional / Authority)</div>`
              }
            </div>
          </div>
        </div>
      `;
      return;
    }

    if(tab === "documents"){
      const list = (d.documents||[]).map(x=>`<li><a href="${esc(x.url)}" target="_blank" rel="noopener">${esc(x.title)}</a></li>`).join("");
      tabBody.innerHTML = `
        <div class="miniCard">
          <div class="miniHead">${ICONS.file} Documents</div>
          <div class="miniBody">
            <ul style="margin:0; padding-left:18px;">${list || "<li>No public documents</li>"}</ul>
          </div>
        </div>
      `;
      return;
    }

    // Access
    const showAuthority = canSee("authority");
    tabBody.innerHTML = `
      <div class="miniCard">
        <div class="miniHead">${ICONS.key} Access</div>
        <div class="miniBody">
          ${viewChip()}
          <div style="height:12px"></div>

          <details>
            <summary>Professional</summary>
            <div style="margin-top:10px; color:var(--muted);">
              ${canSee("professional") || canSee("authority") ? "Enabled (see Circularity tab for repair/materials)." : "Restricted"}
            </div>
          </details>

          <details>
            <summary>Authority</summary>
            <div style="margin-top:10px;">
              ${
                showAuthority
                ? `
                  <div class="kv">
                    <div class="k">SoH</div><div class="v"><b style="color:var(--blue)">${esc(d.authority_dynamic?.soh)}</b></div>
                    <div class="k">Remaining capability</div><div class="v">${esc(d.authority_dynamic?.remaining_capability)}</div>
                    <div class="k">Cycles</div><div class="v">${esc(d.authority_dynamic?.usage_history?.cycles)}</div>
                    <div class="k">High temp exposure</div><div class="v">${esc(d.authority_dynamic?.usage_history?.high_temp_exposure)}</div>
                    <div class="k">Deep discharge</div><div class="v">${esc(d.authority_dynamic?.usage_history?.deep_discharge_events)}</div>
                    <div class="k">Incidents</div><div class="v">${esc(d.authority_dynamic?.usage_history?.incidents)}</div>
                    <div class="k">Status</div><div class="v">${esc(d.authority_dynamic?.status)}</div>
                  </div>

                  <details>
                    <summary>Due diligence</summary>
                    <ul class="detailList">
                      ${(d.due_diligence||[]).map(x=>`<li><b>${esc(x.material)}:</b> <a href="${esc(x.url)}" target="_blank" rel="noopener">${esc(x.evidence)}</a></li>`).join("")}
                    </ul>
                  </details>
                `
                : `<div style="color:var(--muted);">Restricted</div>`
              }
            </div>
          </details>

          <div style="height:12px"></div>
          <button class="btn primary" id="goPro2" style="width:100%; justify-content:center;">Open Professional view</button>
          <div style="height:10px"></div>
          <button class="btn" id="goAuth2" style="width:100%; justify-content:center;">Open Authority view</button>
        </div>
      </div>
    `;

    document.getElementById("goPro2").onclick  = ()=> location.href = linkFor({ role:"professional", tab:"access" });
    document.getElementById("goAuth2").onclick = ()=> location.href = linkFor({ role:"authority", tab:"access" });
  }

  function render(){
    if(!data){ renderNotFound(); return; }

    const overview = `
      <div class="card">
        <div class="head">${ICONS.doc} DPP-Battery Passport</div>
        <div class="body">
          <div class="kv">
            <div class="k">UID</div>
            <div class="v inlineLink">
              <span class="mono">${esc(data.identification?.uid)}</span>
              <span class="iconBtn" id="copyUidTop" title="Copy UID">${ICONS.clip}</span>
            </div>
            <div class="k">Type</div><div class="v">${esc(data.overview?.category)}</div>
            <div class="k">Model</div><div class="v">${esc(data.overview?.model)}</div>
            <div class="k">Manufacturer</div><div class="v">${esc(data.manufacturer?.name)} (${esc(data.manufacturer?.brand)})</div>
            <div class="k">Site</div><div class="v">${esc(data.facility?.location)}</div>
            <div class="k">Production date</div><div class="v">${esc(data.facility?.production)}</div>
          </div>
        </div>
      </div>
    `;

    const safety = `
      <div class="card">
        <div class="head">${ICONS.shield} Safety</div>
        <div class="body">
          <div style="color:var(--muted2); font-weight:900; margin-bottom:6px;">Hazardous substances</div>
          <div style="white-space:pre-line;">${esc(data.safety?.hazardous)}</div>

          <div style="height:12px"></div>

          <div style="color:var(--muted2); font-weight:900; margin-bottom:6px;">Extinguishing agent</div>
          <div style="color:var(--teal); font-weight:900;">${esc(data.safety?.extinguishing)}</div>
        </div>
      </div>
    `;

    const tabs = `
      <div class="tabsShell">
        <div class="tabs" id="tabs">
          ${tabBtn("Details","details", ICONS.info)}
          ${tabBtn("Sustainability","sustainability", ICONS.leaf)}
          ${tabBtn("Circularity","circularity", ICONS.recycle)}
          ${tabBtn("Documents","documents", ICONS.file)}
          ${tabBtn("Access","access", ICONS.key)}
        </div>
        <div class="tabsBody" id="tabBody"></div>
      </div>
    `;

    app.innerHTML = `<div class="grid2">${overview}${safety}</div>${tabs}`;

    document.getElementById("tabs").addEventListener("click",(e)=>{
      const t = e.target.closest(".tab");
      if(!t) return;
      location.href = linkFor({ tab: t.dataset.tab });
    });

    document.getElementById("copyUidTop").onclick = ()=> copy(data.identification?.uid || "");
    showTabBody(document.getElementById("tabBody"));
  }

  render();

  document.getElementById("copyLink").onclick = ()=> copy(location.href);
  document.getElementById("goAccess").onclick = ()=> location.href = linkFor({ tab:"access", role: (role==="public" ? "professional" : role) });
</script>
</body>
</html>
